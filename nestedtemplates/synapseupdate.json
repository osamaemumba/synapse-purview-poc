{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "utcValue": {
        "defaultValue": "[utcNow()]",
        "type": "String"
      }
    },
    "variables": {
      "functionAppName": "[concat('funcapp', uniqueString(resourceGroup().id))]",
      "updateSynapseFunctionName": "updateSynapse",
      "updateSynaseFunctionTriggerUrl": "[concat('http://', variables('functionAppName'), '.azurewebsites.net/api/', variables('updateSynapseFunctionName'))]"
    },
    "resources": [
        {
          "type": "Microsoft.Resources/deploymentScripts",
          "apiVersion": "2020-10-01",
          "name": "synapseWorkspaceArtifacts",
          "location": "eastus",
          "dependsOn": [],
          "kind": "AzurePowerShell",
          "properties": {
            "forceUpdateTag": "[parameters('utcValue')]",
            "azPowerShellVersion": "5.0",
            "arguments": "[concat('-updateSynaseFunctionTriggerUrl', ' ', concat('\\\"https://', variables('updateSynaseFunctionTriggerUrl'))]",
            "scriptContent": "param([string] $updateSynaseFunctionTriggerUrl = $updateSynaseFunctionTriggerUrl)\n\rwhile($true)\n\r{               \n\r        $state = (Get-AzSynapseWorkspace -Name $synapseName).ProvisioningState\n\r        if ($state -eq \"Succeeded\") {break}\n\r        else {Start-Sleep -s 60;continue}\n\r}\n\rInvoke-WebRequest $updateSynapseFunctionTriggerUrl -UseBasicParsing",
            "timeout": "PT1H",
            "cleanupPreference": "OnSuccess",
            "retentionInterval": "P1D"
          }
        }
      ]
    }